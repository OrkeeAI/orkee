name: Build and Release Tauri Desktop App

on:
  push:
    tags: ['desktop-v*']
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@00b27aa7cb85167568cb48a3838b75f4265f2bca # v2.0.0
        with:
          scandir: './packages/dashboard'
          severity: warning
          check_together: 'yes'

  build-tauri:
    name: Build - ${{ matrix.settings.platform }} (${{ matrix.settings.arch }})
    runs-on: ${{ matrix.settings.os }}
    needs: [shellcheck]
    permissions:
      contents: write
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        settings:
          - platform: macos
            arch: x86_64
            os: macos-13  # Intel Mac
            target: x86_64-apple-darwin

          - platform: macos
            arch: aarch64
            os: macos-14  # M1 Mac
            target: aarch64-apple-darwin

          - platform: linux
            arch: x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu

          - platform: windows
            arch: x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Free up disk space
        if: runner.os == 'Linux'
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "Disk space after cleanup:"
          df -h

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          targets: ${{ matrix.settings.target }}

      - name: Install Linux dependencies
        if: matrix.settings.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        # Automatically uses version from package.json "packageManager" field

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@82a92a6e8fbeee089604da2575dc567ae9ddeaab # v2.7.7
        with:
          shared-key: "orkee-tauri-${{ matrix.settings.target }}"
          cache-on-failure: true

      - name: Cache Bun dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install workspace dependencies
        run: |
          # Install at root level to populate root node_modules (required for workspace)
          bun install

      - name: Build dashboard frontend
        run: |
          cd packages/dashboard
          bun run build

      - name: Prepare CLI binary for Tauri
        shell: bash
        env:
          TAURI_TARGET: ${{ matrix.settings.target }}
          CARGO_BUILD_PROFILE: release-ci
        run: |
          bash packages/dashboard/prepare-binaries.sh

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.5.23
        timeout-minutes: 60
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: packages/dashboard
          tauriScript: bun tauri
          args: --target ${{ matrix.settings.target }}

      - name: Verify build artifacts
        shell: bash
        run: |
          echo "Verifying Tauri build artifacts for ${{ matrix.settings.platform }}-${{ matrix.settings.arch }}..."

          BUNDLE_DIR="packages/dashboard/src-tauri/target/${{ matrix.settings.target }}/release/bundle"

          if [ ! -d "$BUNDLE_DIR" ]; then
            echo "Error: Bundle directory not found: $BUNDLE_DIR"
            exit 1
          fi

          echo "Bundle directory exists: $BUNDLE_DIR"
          echo "Contents:"
          ls -lah "$BUNDLE_DIR"

          # Platform-specific artifact verification
          if [ "${{ matrix.settings.platform }}" = "macos" ]; then
            if [ ! -d "$BUNDLE_DIR/dmg" ] && [ ! -d "$BUNDLE_DIR/macos" ]; then
              echo "Error: No macOS installer artifacts found (expected dmg/ or macos/ directory)"
              exit 1
            fi
            echo "âœ“ macOS artifacts verified"
          elif [ "${{ matrix.settings.platform }}" = "windows" ]; then
            if [ ! -d "$BUNDLE_DIR/msi" ] && [ ! -d "$BUNDLE_DIR/nsis" ]; then
              echo "Error: No Windows installer artifacts found (expected msi/ or nsis/ directory)"
              exit 1
            fi
            echo "âœ“ Windows artifacts verified"
          elif [ "${{ matrix.settings.platform }}" = "linux" ]; then
            if [ ! -d "$BUNDLE_DIR/deb" ] && [ ! -d "$BUNDLE_DIR/rpm" ] && [ ! -d "$BUNDLE_DIR/appimage" ]; then
              echo "Error: No Linux installer artifacts found (expected deb/, rpm/, or appimage/ directory)"
              exit 1
            fi
            echo "âœ“ Linux artifacts verified"
          fi

          echo "Build verification complete"

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: tauri-${{ matrix.settings.platform }}-${{ matrix.settings.arch }}
          path: |
            packages/dashboard/src-tauri/target/${{ matrix.settings.target }}/release/bundle/**/*
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: [build-tauri]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/desktop-v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Download all artifacts
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          path: artifacts

      - name: List artifacts
        run: ls -laR artifacts/

      - name: Generate checksums
        run: |
          echo "Generating SHA256 checksums for all artifacts..."
          cd artifacts

          # Find all installer files
          find . -type f \( \
            -name "*.dmg" -o \
            -name "*.pkg" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.AppImage" -o \
            -name "*.msi" -o \
            -name "*.exe" \
          \) -exec sha256sum {} \; > ../checksums.txt

          cd ..

          echo "Checksums generated:"
          cat checksums.txt

          # Create formatted checksums for release notes
          echo "# SHA256 Checksums" > checksums-formatted.txt
          echo "" >> checksums-formatted.txt
          echo "\`\`\`" >> checksums-formatted.txt
          cat checksums.txt >> checksums-formatted.txt
          echo "\`\`\`" >> checksums-formatted.txt

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/desktop-v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          ## Orkee Desktop v${{ steps.get_version.outputs.version }}

          ### What's Included

          This release includes the Orkee Desktop application with **full CLI and TUI access**.

          #### Installation automatically provides:
          - ðŸ–¥ï¸ **Desktop GUI** - Native application with system tray
          - ðŸ’» **CLI Commands** - Full command-line interface (`orkee projects list`, etc.)
          - ðŸŽ¨ **TUI** - Terminal user interface (`orkee tui`)
          - ðŸŒ **Web Dashboard** - Full web interface in native window

          ### âš ï¸ Security Notice: Unsigned Binaries

          **These installers are NOT code-signed.** You will see security warnings:

          **macOS:**
          - **Warning**: "Orkee.app can't be opened because it is from an unidentified developer"
          - **Workaround**: Right-click the app â†’ Open â†’ Click "Open" in the dialog
          - **Alternative**: System Settings â†’ Privacy & Security â†’ "Open Anyway" button
          - **Technical**: `xattr -cr /Applications/Orkee.app` to remove quarantine flag

          **Windows:**
          - **Warning**: "Windows protected your PC" (SmartScreen) or "Unknown publisher"
          - **Workaround**: Click "More info" â†’ "Run anyway"
          - **Note**: Warnings may persist for each installer run

          **Linux:**
          - No code signing warnings (Linux distros don't require code signing for manual installs)
          - Verify integrity using SHA256 checksums below

          **Why unsigned?** Code signing requires paid certificates (Apple Developer Program: $99/year, Windows CA: $200+/year). We plan to add code signing for official releases once funding is available.

          **Security**: Verify downloads using SHA256 checksums provided below. All binaries are built via GitHub Actions with public audit logs.

          ### Installation

          #### macOS
          - Download `Orkee_x86_64.dmg` (Intel) or `Orkee_aarch64.dmg` (Apple Silicon)
          - Open the DMG and drag Orkee to Applications
          - The `orkee` CLI will be automatically installed to `/usr/local/bin`

          #### Windows
          - Download `Orkee_x64_en-US.msi`
          - Run the installer
          - The `orkee` CLI will be automatically added to your PATH

          #### Linux
          - **Debian/Ubuntu**: Download the `.deb` file and run `sudo dpkg -i Orkee_*_amd64.deb`
          - **Fedora/RHEL**: Download the `.rpm` file and run `sudo rpm -i Orkee-*.x86_64.rpm`
          - **AppImage**: Download the `.AppImage` file, make it executable, and run
          - The `orkee` CLI will be automatically installed/linked

          ### Verification

          After installation, verify CLI access:
          ```bash
          orkee --version
          orkee projects list
          orkee tui
          ```

          ### Alternative: npm Installation

          If you prefer using your browser instead of a native app window:
          ```bash
          npm install -g orkee
          ```

          **Note:** npm installation provides the same functionality (CLI, TUI, web dashboard).
          The web dashboard opens in your default browser instead of a native window.

          ---

          EOF

          cat checksums-formatted.txt >> release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
        with:
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.pkg
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.AppImage
            artifacts/**/*.msi
            artifacts/**/*.exe
            checksums.txt
          body_path: release-notes.md
          generate_release_notes: false
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
