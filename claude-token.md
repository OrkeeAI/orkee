# Claude Token Import - Implementation Tracking

**Purpose**: Track the implementation of Claude OAuth token import functionality, removing unnecessary OAuth server complexity from PR #36.

## Progress Summary

- **Overall**: 25/37 tasks completed (68%)
- **Phase 1 (Database)**: 4/4 tasks ‚úÖ
- **Phase 2 (Remove Code)**: 4/4 tasks ‚úÖ
- **Phase 3 (OAuth Manager)**: 8/8 tasks ‚úÖ
- **Phase 4 (Storage)**: 3/3 tasks ‚úÖ
- **Phase 5 (CLI)**: 6/6 tasks ‚úÖ
- **Phase 6 (Testing)**: 0/6 tasks
- **Phase 7 (Docs)**: 0/6 tasks

**Estimated Time**: ~2.5 hours

## Overview

We need to simplify the OAuth implementation from PR #36 by removing the OAuth server components while keeping the `oauth_tokens` table for storing Claude's long-lived session tokens generated by `claude setup-token`.

### Scope of Changes

**What We're Removing** (~850 lines):
- OAuth callback server (port 3737)
- PKCE implementation
- OAuth provider configurations
- Authorization code exchange
- Token refresh logic

**What We're Keeping**:
- `oauth_tokens` table (correctly designed for OAuth tokens)
- Token encryption (ChaCha20-Poly1305)
- Token storage/retrieval methods
- Expiration tracking

**What We're Adding** (~150 lines):
- Simple `import_token()` method
- Claude token extraction from `claude setup-token` output
- Direct file import support

## Implementation Phases

### Phase 1: Database Schema Cleanup ‚úÖ
- [x] Remove `oauth_providers` table from `001_initial_schema.sql` (lines 728-740)
- [x] Keep `oauth_tokens` table as-is (lines 709-726)
- [x] Fix oauth token indexes after removing provider table
- [x] Update `001_initial_schema.down.sql` to remove oauth_providers drop

#### Exact Changes for 001_initial_schema.sql

**DELETE lines 728-740 entirely:**
```sql
-- OAuth Provider Configurations
CREATE TABLE oauth_providers (
    provider TEXT PRIMARY KEY CHECK (provider IN ('claude', 'openai', 'google', 'xai')),
    client_id TEXT NOT NULL,
    client_secret TEXT, -- Encrypted, if needed
    auth_url TEXT NOT NULL,
    token_url TEXT NOT NULL,
    redirect_uri TEXT NOT NULL,
    scopes TEXT NOT NULL, -- Space-separated
    enabled BOOLEAN DEFAULT 1,
    created_at INTEGER NOT NULL DEFAULT (unixepoch()),
    updated_at INTEGER NOT NULL DEFAULT (unixepoch())
);
```

**KEEP the oauth_tokens table (lines 709-726) EXACTLY AS-IS:**
```sql
-- OAuth Tokens
-- OAuth tokens for AI providers (encrypted storage)
CREATE TABLE oauth_tokens (
    id TEXT PRIMARY KEY CHECK(length(id) >= 8),
    user_id TEXT NOT NULL,
    provider TEXT NOT NULL CHECK (provider IN ('claude', 'openai', 'google', 'xai')),
    access_token TEXT NOT NULL, -- Encrypted (length varies based on plaintext)
    refresh_token TEXT, -- Encrypted (length varies based on plaintext)
    expires_at INTEGER NOT NULL, -- Unix timestamp
    token_type TEXT DEFAULT 'Bearer',
    scope TEXT, -- Space-separated scopes
    subscription_type TEXT, -- 'pro', 'max', 'plus', etc.
    account_email TEXT, -- From token info
    created_at INTEGER NOT NULL DEFAULT (unixepoch()),
    updated_at INTEGER NOT NULL DEFAULT (unixepoch()),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE(user_id, provider)
);
```

**UPDATE lines 742-745 (indexes) - just renumber after deletion:**
```sql
-- OAuth indexes
CREATE INDEX idx_oauth_tokens_user ON oauth_tokens(user_id);
CREATE INDEX idx_oauth_tokens_provider ON oauth_tokens(provider);
CREATE INDEX idx_oauth_tokens_expires ON oauth_tokens(expires_at);
```

#### Changes for 001_initial_schema.down.sql

**REMOVE line 69:**
```sql
DROP TABLE IF EXISTS oauth_providers;  -- DELETE THIS LINE
```

The oauth_tokens table drop should remain (line 68).

### Phase 2: Remove OAuth Server Code ‚úÖ
- [x] Delete `packages/auth/src/oauth/server.rs` (258 lines - OAuth callback server)
- [x] Delete `packages/auth/src/oauth/pkce.rs` (128 lines - PKCE implementation)
- [x] Delete `packages/auth/src/oauth/provider.rs` (146 lines - Provider configs)
- [x] Remove unused imports from remaining OAuth files

#### Update packages/auth/src/oauth/mod.rs

Remove module declarations for deleted files:

```rust
// packages/auth/src/oauth/mod.rs

pub mod manager;
pub mod storage;
pub mod types;
// DELETE THESE LINES:
// pub mod server;
// pub mod pkce;
// pub mod provider;

pub use manager::OAuthManager;
pub use storage::OAuthStorage;
pub use types::{OAuthToken, ProviderStatus};
// DELETE THESE LINES:
// pub use provider::OAuthProvider;
// pub use pkce::PkceChallenge;
```

#### Update packages/auth/src/error.rs if needed

Add any missing error variants:

```rust
#[derive(Debug, thiserror::Error)]
pub enum AuthError {
    // ... existing variants ...

    #[error("Invalid token: {0}")]
    InvalidToken(String),

    #[error("Invalid provider: {0}")]
    InvalidProvider(String),

    // Remove if exists (no longer needed):
    // #[error("OAuth callback failed: {0}")]
    // OAuthCallback(String),
}
```

### Phase 3: Simplify OAuth Manager ‚úÖ
- [x] Remove `authenticate()` method from `manager.rs` (lines 61-155)
- [x] Remove `refresh_token()` method (lines 190-291)
- [x] Remove `build_auth_url()` method (lines 330-350)
- [x] Remove `exchange_code_for_token()` method (lines 352-390)
- [x] Remove `detect_subscription_type()` method (lines 392-399)
- [x] Remove `get_account_email()` method (lines 401-408)
- [x] Remove `default_provider_config()` method (lines 410-426)
- [x] Add new `import_token()` method for direct token import

#### New import_token() Method

Add this method to `packages/auth/src/oauth/manager.rs`:

```rust
/// Import a token directly without OAuth flow (for Claude session keys)
pub async fn import_token(&self, token: OAuthToken) -> AuthResult<()> {
    info!(
        "Importing {} token for user {}",
        token.provider, token.user_id
    );

    // Validate token format for known providers
    match token.provider.as_str() {
        "claude" => {
            if !token.access_token.starts_with("sk-ant-") {
                return Err(AuthError::InvalidToken(
                    "Claude tokens should start with 'sk-ant-'".into()
                ));
            }
            // Specifically check for OAuth token format, not API key
            if !token.access_token.starts_with("sk-ant-oat01-") {
                warn!(
                    "Token appears to be a Claude API key (not OAuth token). \
                     OAuth tokens start with 'sk-ant-oat01-'. \
                     API keys should be stored in Settings instead."
                );
            }
        }
        "openai" | "google" | "xai" => {
            // These providers would need their own validation once implemented
            warn!("{} token import not yet fully implemented", token.provider);
        }
        _ => {
            return Err(AuthError::InvalidProvider(format!(
                "Unknown provider: {}",
                token.provider
            )));
        }
    }

    // Store the encrypted token
    self.storage.store_token(&token).await?;

    info!("Successfully imported {} token", token.provider);
    Ok(())
}
```

#### Update Manager Imports

Remove unused imports at the top of `packages/auth/src/oauth/manager.rs`:

```rust
// REMOVE these imports (no longer needed):
use crate::oauth::pkce::PkceChallenge;
use crate::oauth::server::OAuthCallbackServer;
use crate::oauth::provider::{OAuthProvider, get_provider_config};

// KEEP these imports:
use crate::oauth::storage::OAuthStorage;
use crate::oauth::types::{OAuthToken, ProviderStatus};
use crate::error::{AuthError, AuthResult};
```

### Phase 4: Simplify OAuth Storage ‚úÖ
- [x] Remove `store_provider_config()` from `storage.rs` (lines 181-218)
- [x] Remove `get_provider_config()` from `storage.rs` (lines 220-262)
- [x] Keep all token storage methods (they work correctly)

### Phase 5: Update CLI Commands ‚úÖ
- [x] Update `login_command()` in `auth.rs` to handle Claude token import
- [x] Add support for `orkee auth login claude` (auto-runs setup)
- [x] Add support for `orkee auth login claude --file token.txt`
- [x] Add error handling for non-Claude providers
- [x] Add token extraction logic from claude setup-token output
- [x] Update help text and command descriptions

#### Complete Implementation for login_command()

Replace the entire `login_command()` function in `packages/cli/src/bin/cli/auth.rs`:

```rust
use std::process::{Command, Stdio};
use std::fs;

async fn login_command(provider_str: &str, file: Option<&str>) -> Result<(), String> {
    let provider = parse_provider(provider_str)?;

    match provider {
        Provider::Claude => {
            if let Some(file_path) = file {
                import_claude_from_file(file_path).await
            } else {
                import_claude_from_setup().await
            }
        }
        Provider::OpenAI | Provider::Google | Provider::XAI => {
            Err(format!(
                "{} OAuth not yet implemented. Please use API keys in Settings instead.",
                provider
            ))
        }
    }
}

async fn import_claude_from_setup() -> Result<(), String> {
    println!("üîê Running 'claude setup-token' to generate authentication token...");
    println!("   This will open your browser for authentication.\n");

    // Run claude setup-token
    let output = Command::new("claude")
        .arg("setup-token")
        .stdin(Stdio::inherit())   // Allow browser interaction
        .stdout(Stdio::piped())    // Capture token output
        .stderr(Stdio::inherit())  // Show progress to user
        .output()
        .map_err(|e| {
            if e.kind() == std::io::ErrorKind::NotFound {
                "Claude CLI not found. Please install it first:\n  npm install -g @anthropic-ai/claude-code".to_string()
            } else {
                format!("Failed to run 'claude setup-token': {}", e)
            }
        })?;

    if !output.status.success() {
        return Err("claude setup-token failed. Please try again.".into());
    }

    // Extract token from output
    let stdout = String::from_utf8_lossy(&output.stdout);
    let token = extract_claude_token(&stdout)?;

    // Store in oauth_tokens table
    store_claude_token(&token).await?;

    println!("\n‚úÖ Claude authentication token imported successfully!");
    println!("   Token expires in 1 year.");

    show_encryption_warning().await;
    Ok(())
}

async fn import_claude_from_file(file_path: &str) -> Result<(), String> {
    println!("üìÑ Importing Claude token from file: {}", file_path);

    let token = fs::read_to_string(file_path)
        .map_err(|e| format!("Failed to read file: {}", e))?
        .trim()
        .to_string();

    // Validate token format
    if !token.starts_with("sk-ant-oat01-") {
        return Err(
            "Invalid token format. Claude OAuth tokens should start with 'sk-ant-oat01-'.\n\
             If you have an API key (sk-ant-api03-), use Settings instead.".into()
        );
    }

    store_claude_token(&token).await?;

    println!("\n‚úÖ Claude authentication token imported successfully!");
    println!("   Token expires in 1 year.");

    show_encryption_warning().await;
    Ok(())
}

fn extract_claude_token(output: &str) -> Result<String, String> {
    // Look for token in output (appears after success message)
    for line in output.lines() {
        let trimmed = line.trim();
        if trimmed.starts_with("sk-ant-oat01-") {
            return Ok(trimmed.to_string());
        }
    }

    Err(
        "Could not find token in command output.\n\
         The token should start with 'sk-ant-oat01-'.\n\
         Please try running 'claude setup-token' manually and use --file option.".into()
    )
}

async fn store_claude_token(token: &str) -> Result<(), String> {
    use chrono::Utc;
    use nanoid::nanoid;

    let manager = OAuthManager::new_default().await
        .map_err(|e| format!("Failed to initialize OAuth manager: {}", e))?;

    let oauth_token = OAuthToken {
        id: nanoid!(),
        user_id: "default-user".to_string(),  // TODO: Implement user system
        provider: "claude".to_string(),
        access_token: token.to_string(),
        refresh_token: None,  // Claude tokens don't refresh
        expires_at: Utc::now().timestamp() + (365 * 24 * 60 * 60), // 1 year
        token_type: "Bearer".to_string(),
        scope: Some("model:claude account:read".to_string()),
        subscription_type: None,  // Could detect later via API
        account_email: None,      // Could detect later via API
    };

    manager.import_token(oauth_token).await
        .map_err(|e| format!("Failed to store token: {}", e))?;

    Ok(())
}
```

#### Update refresh_command() for Claude

Add this check at the beginning of `refresh_command()`:

```rust
async fn refresh_command(provider_str: &str) -> Result<(), String> {
    let provider = parse_provider(provider_str)?;

    // Claude tokens cannot be refreshed
    if provider == Provider::Claude {
        return Err(
            "‚ùå Claude tokens cannot be refreshed. They expire after 1 year.\n\
             \n\
             To get a new token, run:\n\
                orkee auth login claude\n\
             \n\
             This will generate a new 1-year token.".into()
        );
    }

    // Rest of existing refresh logic for other providers...
}
```

### Phase 6: Testing & Verification ‚è≥
- [ ] Test `orkee auth login claude` (auto-setup flow)
- [ ] Test `orkee auth login claude --file` (file import)
- [ ] Verify token encryption in database
- [ ] Test `orkee auth status` shows Claude correctly
- [ ] Test `orkee auth logout claude` removes token
- [ ] Test error cases (invalid token, missing CLI, etc.)

#### Test Commands and Expected Output

```bash
# Test 1: Auto-import via claude setup-token
$ orkee auth login claude
üîê Running 'claude setup-token' to generate authentication token...
   This will open your browser for authentication.

[Browser opens for authentication]

‚úÖ Claude authentication token imported successfully!
   Token expires in 1 year.

‚ö†Ô∏è  SECURITY WARNING

   Tokens are encrypted with machine-based encryption
   This provides transport encryption only - anyone with access to
   ~/.orkee/orkee.db can decrypt your tokens.

   For production use or shared machines, upgrade to password-based encryption:

      orkee security set-password

# Test 2: Import from file
$ echo "sk-ant-oat01-2-sDpwPgSadVYuL..." > /tmp/token.txt
$ orkee auth login claude --file /tmp/token.txt
üìÑ Importing Claude token from file: /tmp/token.txt

‚úÖ Claude authentication token imported successfully!
   Token expires in 1 year.

[Security warning shown]

# Test 3: Status check
$ orkee auth status
‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
‚îÇ Authentication Status                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Provider  ‚îÇ Status    ‚îÇ Expires             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ claude    ‚îÇ ‚úì Active  ‚îÇ 2025-11-05         ‚îÇ
‚îÇ openai    ‚îÇ ‚úó None    ‚îÇ -                  ‚îÇ
‚îÇ google    ‚îÇ ‚úó None    ‚îÇ -                  ‚îÇ
‚îÇ xai       ‚îÇ ‚úó None    ‚îÇ -                  ‚îÇ
‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ

# Test 4: Invalid token format
$ echo "sk-ant-api03-wrongtype" > /tmp/bad.txt
$ orkee auth login claude --file /tmp/bad.txt
üìÑ Importing Claude token from file: /tmp/bad.txt
‚ùå Error: Invalid token format. Claude OAuth tokens should start with 'sk-ant-oat01-'.
If you have an API key (sk-ant-api03-), use Settings instead.

# Test 5: Claude CLI not found
$ mv $(which claude) /tmp/claude.bak 2>/dev/null || true
$ orkee auth login claude
üîê Running 'claude setup-token' to generate authentication token...
‚ùå Error: Claude CLI not found. Please install it first:
  npm install -g @anthropic-ai/claude-code

# Test 6: Refresh attempt (should fail)
$ orkee auth refresh claude
‚ùå Claude tokens cannot be refreshed. They expire after 1 year.

To get a new token, run:
   orkee auth login claude

This will generate a new 1-year token.

# Test 7: Logout
$ orkee auth logout claude
‚úì Successfully logged out from claude

# Test 8: Verify encryption in database
$ sqlite3 ~/.orkee/orkee.db "SELECT provider, length(access_token), substr(access_token, 1, 10) FROM oauth_tokens WHERE provider='claude';"
claude|156|7J3mX9Qp2L   # Base64 encrypted gibberish, not the actual token
```

### Phase 7: Documentation Updates ‚è≥
- [ ] Update this file with correct terminology (OAuth token, not API key)
- [ ] Update command examples to use `orkee auth login claude`
- [ ] Add token format clarification section
- [ ] Update help text in CLI
- [ ] Remove references to OAuth server in CLAUDE.md
- [ ] Update README.md auth section

## Token Information

### Claude Setup Token Flow

### What `claude setup-token` Does

1. Opens browser to Claude authentication page
2. User authenticates with Claude account
3. Claude generates a long-lived session key (1 year validity)
4. Returns to terminal with ASCII art success screen
5. Outputs the token to stdout in format:

```
‚úì Long-lived authentication token created successfully!

Your OAuth token (valid for 1 year):

sk-ant-oat01-2-sDpwPgSadVYuL_EHpXM7Zk621dmLUtjIg1BLNozIs7rnukzR4u7Iiu4iyuoWq9hLatJwP88COeAc3WDtLYNw-3D5X1wAA

Store this token securely. You won't be able to see it again.

Use this token by setting: export CLAUDE_CODE_OAUTH_TOKEN=<token>
```

### Token Characteristics

- **Format**: `sk-ant-oat01-...` (OAuth Access Token v01)
- **Length**: ~100+ characters
- **Type**: Long-lived OAuth session token (1-year validity)
- **Storage**: `oauth_tokens` table (NOT `users.anthropic_api_key`)
- **Validity**: 1 year from creation
- **Refresh**: Not possible - must re-authenticate when expired
- **Scope**: Implicitly `model:claude account:read`

### Token Types Clarification

| Token Format | Type | Purpose | Storage Location |
|--------------|------|---------|------------------|
| `sk-ant-oat01-...` | OAuth Access Token | Claude Code CLI | `oauth_tokens.access_token` |
| `sk-ant-api03-...` | API Key | Direct API calls | `users.anthropic_api_key` |
| `sk-ant-ort01-...` | OAuth Refresh Token | Not used | N/A |

## Target Implementation

### Command Structure

```bash
orkee auth login claude              # Auto-run claude setup-token
orkee auth login claude --file path # Import from file
```

### Key Components (After Simplification)

#### 1. CLI Command Handler (`packages/cli/src/bin/cli/auth.rs`)

**Updated Function**: `login_command(provider_str: &str, file: Option<&str>)`

**Flow for Claude**:
1. Check if provider is Claude (only supported provider for now)
2. If `--file` provided:
   - Read token from file
   - Validate format (must start with `sk-ant-oat01-`)
3. Otherwise:
   - Run `claude setup-token` command
   - Capture stdout to extract token
   - Parse output for token line
4. Create `OAuthToken` struct with:
   - `id`: Generated nanoid
   - `user_id`: "default-user" (TODO: implement user system)
   - `provider`: "claude"
   - `access_token`: The OAuth token
   - `refresh_token`: None (Claude tokens don't refresh)
   - `expires_at`: Current timestamp + 365 days
   - `token_type`: "Bearer"
   - `scope`: Some("model:claude account:read")
5. Call `manager.import_token(token)` to store
6. Show success message and encryption warning

#### 2. OAuth Manager (`packages/auth/src/oauth/manager.rs`)

**New Method**: `import_token(&self, token: OAuthToken) -> AuthResult<()>`

**Purpose**: Direct token import without OAuth flow

**Implementation**:
```rust
pub async fn import_token(&self, token: OAuthToken) -> AuthResult<()> {
    info!("Importing {} token", token.provider);
    self.storage.store_token(&token).await?;
    Ok(())
}
```

**Removed Methods**:
- `authenticate()` - No OAuth flow needed
- `refresh_token()` - Claude tokens don't refresh
- `build_auth_url()` - No authorization URL
- `exchange_code_for_token()` - No code exchange

#### 3. Token Storage (`packages/auth/src/oauth/storage.rs`)

**Method**: `OAuthStorage::store_token(&self, token: &OAuthToken) -> AuthResult<()>`

**Process**:
1. Encrypt `access_token` with ChaCha20-Poly1305
2. Encrypt `refresh_token` if present (None for session keys)
3. Upsert to `oauth_tokens` table with ON CONFLICT UPDATE
4. Store encrypted values only

**Database Schema**:
```sql
INSERT INTO oauth_tokens (
    id, user_id, provider, access_token, refresh_token,
    expires_at, token_type, scope, subscription_type, account_email,
    created_at, updated_at
)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, unixepoch(), unixepoch())
ON CONFLICT(user_id, provider) DO UPDATE SET
    access_token = excluded.access_token,
    refresh_token = excluded.refresh_token,
    expires_at = excluded.expires_at,
    -- ... other fields
    updated_at = unixepoch()
```

**Unique constraint**: `(user_id, provider)` ensures one token per provider per user

## Security Considerations

### Encryption

- **Algorithm**: ChaCha20-Poly1305 AEAD
- **Key Derivation**:
  - Machine-based (default): HKDF-SHA256 from machine ID + username + hostname
  - Password-based (recommended): Argon2id from user password
- **Storage**: `~/.orkee/orkee.db` SQLite database

### Token Handling

- ‚úÖ Never logged in plain text
- ‚úÖ Encrypted before database storage
- ‚úÖ Only decrypted in-memory when needed
- ‚úÖ Validated format before storage
- ‚ö†Ô∏è Machine-based encryption provides transport security only
- ‚ö†Ô∏è Password-based encryption recommended for production

### Warnings Shown to User

After successful import, the system checks encryption mode and shows:

```
‚ö†Ô∏è  SECURITY WARNING

   Tokens are encrypted with machine-based encryption
   This provides transport encryption only - anyone with access to
   ~/.orkee/orkee.db can decrypt your tokens.

   For production use or shared machines, upgrade to password-based encryption:

      orkee security set-password
```

## Testing

### Manual Testing

```bash
# Create test token file
echo "sk-ant-test-token-12345" > /tmp/test-token.txt

# Test file import
cargo run --package orkee-cli --bin orkee -- auth import claude --file /tmp/test-token.txt

# Verify storage
cargo run --package orkee-cli --bin orkee -- auth status

# Check encryption
sqlite3 ~/.orkee/orkee.db "SELECT provider, substr(access_token, 1, 20) FROM oauth_tokens;"

# Cleanup
sqlite3 ~/.orkee/orkee.db "DELETE FROM oauth_tokens WHERE provider = 'claude';"
rm /tmp/test-token.txt
```

### Verification Checklist

- [ ] Token is captured correctly from `claude setup-token` output
- [ ] Token is validated (starts with `sk-ant-`)
- [ ] Token is encrypted in database (not plain text)
- [ ] Token shows in `orkee auth status` with correct expiration
- [ ] Security warning is displayed (if using machine encryption)
- [ ] File import works with `--file` parameter
- [ ] Empty/invalid tokens are rejected with clear error
- [ ] Error messages guide user to alternatives

## Important Notes

### Command Changes
- **OLD (from PR #36)**: `orkee auth import claude --file token.txt`
- **NEW (simplified)**: `orkee auth login claude` or `orkee auth login claude --file token.txt`
- Using `login` command makes it consistent with other providers

### Database Decisions
- Keep using `oauth_tokens` table (semantically correct for OAuth tokens)
- Do NOT use `users.anthropic_api_key` (that's for API keys like `sk-ant-api03-...`)
- Claude tokens are OAuth tokens (`sk-ant-oat01-...`), not API keys

## Known Limitations

1. **Claude Only**: Currently only supports Claude provider
   - Other providers should use standard OAuth flow (`orkee auth login <provider>`)
   - Could extend to other providers with session key flows

2. **No Refresh**: Session keys can't be refreshed
   - User must re-import when token expires
   - `orkee auth refresh claude` will fail for imported tokens

3. **Limited Metadata**: Can't determine from session key:
   - Subscription type (Free/Pro/Team)
   - Account email
   - Would need to call Claude API to get this info

4. **User ID Hardcoded**: Uses "default-user"
   - TODO: Implement proper user management system
   - Currently assumes single user per Orkee installation

## Future Enhancements

1. **Account Info Detection**
   - Make API call after import to fetch subscription type and email
   - Store in `OAuthToken` metadata fields
   - Show in `orkee auth status` output

2. **Multi-User Support**
   - Replace hardcoded "default-user"
   - Implement user session management
   - Allow multiple users per Orkee instance

3. **Token Rotation Reminders**
   - Warn user when token is close to expiration (30 days)
   - Suggest re-import before expiration
   - Track token creation date for rotation recommendations

4. **Other Provider Support**
   - Research if OpenAI/Google/xAI have similar session key flows
   - Add provider-specific setup command mapping
   - Extend token format validation

## Troubleshooting

### Token Not Captured

**Symptom**: "Could not find token in command output"

**Causes**:
- Claude CLI version changed output format
- Token not written to stdout
- Output buffering issues

**Debug**:
```bash
# Test claude setup-token output directly
claude setup-token 2>&1 | tee /tmp/claude-output.txt

# Check what we actually captured
cat /tmp/claude-output.txt | grep "sk-ant"
```

### Invalid Token Format

**Symptom**: "Invalid token format. Claude tokens should start with 'sk-ant-'"

**Causes**:
- Token file has extra whitespace/newlines
- Partial token (truncated)
- Wrong token type (API key vs session key)

**Fix**:
```bash
# Clean token file
echo "sk-ant-..." | tr -d '\n' > /tmp/clean-token.txt
orkee auth import claude --file /tmp/clean-token.txt
```

### Encryption Initialization Fails

**Symptom**: "Failed to initialize encryption"

**Causes**:
- Database not accessible
- Encryption settings corrupted

**Fix**:
```bash
# Check database
sqlite3 ~/.orkee/orkee.db "SELECT * FROM encryption_settings;"

# Reset if needed (WARNING: loses all encrypted data)
rm ~/.orkee/orkee.db
orkee auth login claude
```

## Related Files

- `packages/cli/src/bin/cli/auth.rs` - CLI command implementation
- `packages/auth/src/oauth/manager.rs` - OAuth manager with import method
- `packages/auth/src/oauth/storage.rs` - Encrypted token storage
- `packages/auth/src/oauth/types.rs` - OAuthToken struct definition
- `packages/security/src/encryption/mod.rs` - ChaCha20-Poly1305 encryption

## References

- Claude CLI: https://www.npmjs.com/package/@anthropic-ai/claude-code
- ChaCha20-Poly1305: https://datatracker.ietf.org/doc/html/rfc8439
- Argon2id: https://datatracker.ietf.org/doc/html/rfc9106

## Final Verification Checklist

After completing all phases, verify:

### Code Changes
- [ ] `oauth_providers` table removed from schema
- [ ] 3 OAuth server files deleted (server.rs, pkce.rs, provider.rs)
- [ ] `import_token()` method added to manager.rs
- [ ] `login_command()` updated for Claude token import
- [ ] Module declarations updated in oauth/mod.rs
- [ ] Unused imports removed from all files

### Functionality Tests
- [ ] `orkee auth login claude` opens browser and captures token
- [ ] `orkee auth login claude --file` imports from file
- [ ] Tokens are encrypted in database (not plaintext)
- [ ] `orkee auth status` shows Claude with expiration
- [ ] `orkee auth logout claude` removes token
- [ ] `orkee auth refresh claude` shows appropriate error
- [ ] Other providers show "not implemented" message

### Build & Compilation
- [ ] `cargo build --package orkee-auth` compiles without errors
- [ ] `cargo build --package orkee-cli` compiles without errors
- [ ] `cargo test --package orkee-auth` passes
- [ ] No unused import warnings
- [ ] No dead code warnings for OAuth-related code

### Documentation
- [ ] This file updated with progress checkmarks
- [ ] Command examples show correct syntax
- [ ] Token format clarification is clear
- [ ] CLAUDE.md updated if needed
- [ ] README.md auth section updated

### Edge Cases
- [ ] Claude CLI not installed - shows helpful error
- [ ] Invalid token format - shows clear error
- [ ] Empty token file - handled gracefully
- [ ] Token with whitespace - trimmed correctly
- [ ] Machine vs password encryption warning shown

## Completion Sign-off

When all checkboxes are marked:
- [ ] All 37 implementation tasks completed
- [ ] All verification checks passed
- [ ] Ready for PR review
- [ ] oauth-fix.md can be deleted (implementation complete)
