# Build Guide for Orkee

## Database and SQLx Configuration

### Overview
Orkee uses SQLx for compile-time query verification. To avoid requiring a live database during builds, we use **offline mode** with cached query metadata.

### How It Works

1. **`.sqlx/` Directory**: Contains cached query metadata for all SQLx macros
   - Committed to git for reproducible builds
   - Generated by `cargo sqlx prepare --workspace`
   - Updated when new database queries are added

2. **`.cargo/config.toml`**: Enables offline mode by default
   - Sets `SQLX_OFFLINE=true` environment variable
   - Allows builds without database connection
   - Works in CI/CD pipelines

### Building

```bash
# Standard build (uses offline mode automatically)
cargo build --release -p orkee-cli

# No need to set SQLX_OFFLINE manually - it's configured in .cargo/config.toml
```

### Adding New Database Queries

When you add new SQLx queries (e.g., `sqlx::query!`, `sqlx::query_as!`):

1. **Ensure database is running**:
   ```bash
   sqlite3 ~/.orkee/orkee.db
   ```

2. **Update the query cache**:
   ```bash
   cargo sqlx prepare --workspace --database-url "sqlite:///Users/danziger/.orkee/orkee.db"
   ```

3. **Commit the changes**:
   ```bash
   git add .sqlx/
   git commit -m "Update sqlx query cache"
   ```

### Safety Considerations

**Query Validation in Offline Mode**
- Queries are validated when `cargo sqlx prepare` is run (not during build)
- The `.sqlx/` cache contains validated schema information
- Offline mode uses cached validation instead of re-checking against database
- **This is safe** - validation still happens, just at prepare time

**Preventing Stale Cache Issues**
- A pre-commit hook warns if Rust files change without updating `.sqlx/`
- Always run `cargo sqlx prepare --workspace` after adding new queries
- The hook can be bypassed with `git commit --no-verify` if needed

**Database Schema Changes**
- If database schema changes, `cargo sqlx prepare` will fail
- This forces developers to update queries before committing
- Prevents silent failures from schema mismatches

### Troubleshooting

**Build fails with "unable to open database file"**
- Ensure `.sqlx/` directory is present and committed
- Run `cargo sqlx prepare --workspace` to regenerate cache
- Check that `SQLX_OFFLINE=true` is set (should be automatic via `.cargo/config.toml`)

**New queries not recognized**
- Run `cargo sqlx prepare --workspace` after adding new queries
- Commit the updated `.sqlx/` directory
- Pre-commit hook will warn if you forget

**Pre-commit hook not working**
- Ensure git hooks are configured: `git config core.hooksPath .githooks`
- Make hook executable: `chmod +x .githooks/pre-commit`

### CI/CD Integration

The offline mode configuration works automatically in CI/CD:
- No database setup needed
- No `SQLX_OFFLINE` environment variable needed
- Just clone the repo and run `cargo build`

### References

- [SQLx Documentation](https://github.com/launchbadge/sqlx)
- [SQLx Offline Mode](https://github.com/launchbadge/sqlx/blob/main/sqlx-cli/README.md#offline-mode)
